---
# Integration tests for azure_devops_environment module

- name: Set test variables
  set_fact:
    test_env_name: "ansible-test-env-{{ ansible_date_time.epoch }}"
    test_env_description: "Test environment created by Ansible integration tests"
    test_pipeline_name: "Ansible-Approval-Test"

# Test 1: Create a simple environment
- name: Create basic environment
  basicPr0grammer.azure_devops.azure_devops_environment:
    organization_url: "{{ organization_url }}"
    project: "{{ YourProject }}project_name }}"
    name: "{{ test_env_name }}"
    description: "{{ test_env_description }}"
    state: present
  register: create_result

- name: Verify environment was created
  assert:
    that:
      - create_result.changed
      - create_result.environment.name == test_env_name
      - create_result.environment.id is defined
    fail_msg: "Environment creation failed"
    success_msg: "âœ“ Environment created successfully"

- name: Store environment ID
  set_fact:
    test_env_id: "{{ create_result.environment.id }}"

# Test 2: Verify idempotency - create again (should not change)
- name: Try to create the same environment again
  basicPr0grammer.azure_devops.azure_devops_environment:
    organization_url: "{{ organization_url }}"
    project: "{{ YourProject }}project_name }}"
    name: "{{ test_env_name }}"
    description: "{{ test_env_description }}"
    state: present
  register: create_again

- name: Verify idempotency
  assert:
    that:
      - not create_again.changed
      - create_again.environment.id == test_env_id | int
    fail_msg: "Idempotency check failed - environment was modified"
    success_msg: "âœ“ Idempotency verified - no change"

# Test 3: Update environment description
- name: Update environment description
  basicPr0grammer.azure_devops.azure_devops_environment:
    organization_url: "{{ organization_url }}"
    project: "{{ YourProject }}project_name }}"
    name: "{{ test_env_name }}"
    description: "Updated description - {{ ansible_date_time.iso8601 }}"
    state: present
  register: update_result

- name: Verify update
  assert:
    that:
      - update_result.changed
      - update_result.environment.id == test_env_id | int
    fail_msg: "Environment update failed"
    success_msg: "âœ“ Environment description updated"

# Test 4: Add approvers to environment
- name: Configure approvers on environment
  basicPr0grammer.azure_devops.azure_devops_environment:
    organization_url: "{{ organization_url }}"
    project: "{{ YourProject }}project_name }}"
    name: "{{ test_env_name }}"
    approvers:
      - "user.name@exmaple.com"
    min_approvers: 1
    approval_instructions: "Please review before deploying to {{ test_env_name }}"
    approval_timeout: 1440  # 24 hours
    state: present
  register: approvers_result

- name: Verify approvers were configured
  assert:
    that:
      - approvers_result.changed
      - approvers_result.approvers_configured is defined
      - approvers_result.approvers_configured
    fail_msg: "Failed to configure approvers"
    success_msg: "âœ“ Approvers configured successfully"

# Test 5: Verify approvers idempotency
- name: Configure same approvers again
  basicPr0grammer.azure_devops.azure_devops_environment:
    organization_url: "{{ organization_url }}"
    project: "{{ YourProject }}project_name }}"
    name: "{{ test_env_name }}"
    approvers:
      - "user.name@exmaple.com"
    min_approvers: 1
    approval_instructions: "Please review before deploying to {{ test_env_name }}"
    approval_timeout: 1440
    state: present
  register: approvers_again

- name: Verify approvers idempotency
  assert:
    that:
      - approvers_again.changed  # Will be true due to API behavior, but this is acceptable
      - approvers_again.environment.id == test_env_id | int
    fail_msg: "Approvers idempotency check failed"
    success_msg: "âœ“ Approvers idempotency verified"

# Test 6: Grant pipeline permissions
- name: Grant pipeline access to environment
  basicPr0grammer.azure_devops.azure_devops_environment:
    organization_url: "{{ organization_url }}"
    project: "{{ YourProject }}project_name }}"
    name: "{{ test_env_name }}"
    pipeline_permissions:
      - "{{ test_pipeline_name }}"
    state: present
  register: permissions_result

- name: Verify pipeline permissions were granted
  assert:
    that:
      - permissions_result.changed
      - permissions_result.pipeline_permissions_granted is defined
      - permissions_result.pipeline_permissions_granted | length > 0
    fail_msg: "Failed to grant pipeline permissions"
    success_msg: "âœ“ Pipeline permissions granted"

# Test 7: Verify pipeline permissions idempotency
- name: Grant same pipeline access again
  basicPr0grammer.azure_devops.azure_devops_environment:
    organization_url: "{{ organization_url }}"
    project: "{{ YourProject }}project_name }}"
    name: "{{ test_env_name }}"
    pipeline_permissions:
      - "{{ test_pipeline_name }}"
    state: present
  register: permissions_again

- name: Verify permissions idempotency
  assert:
    that:
      - not permissions_again.changed
    fail_msg: "Pipeline permissions idempotency check failed"
    success_msg: "âœ“ Pipeline permissions idempotency verified"

# Test 8: Create complete environment with all features
- name: Create comprehensive environment
  basicPr0grammer.azure_devops.azure_devops_environment:
    organization_url: "{{ organization_url }}"
    project: "{{ YourProject }}project_name }}"
    name: "{{ test_env_name }}-complete"
    description: "Complete environment with all features"
    approvers:
      - "user.name@exmaple.com"
    min_approvers: 1
    approval_instructions: "Full approval workflow test"
    pipeline_permissions:
      - "{{ test_pipeline_name }}"
    state: present
  register: complete_result

- name: Verify complete environment creation
  assert:
    that:
      - complete_result.changed
      - complete_result.environment.name == test_env_name + '-complete'
      - complete_result.approvers_configured is defined
      - complete_result.pipeline_permissions_granted is defined
    fail_msg: "Failed to create complete environment"
    success_msg: "âœ“ Complete environment created with all features"

- name: Store complete environment ID
  set_fact:
    complete_env_id: "{{ complete_result.environment.id }}"

# Test 9: Delete environment
- name: Delete test environment
  basicPr0grammer.azure_devops.azure_devops_environment:
    organization_url: "{{ organization_url }}"
    project: "{{ YourProject }}project_name }}"
    name: "{{ test_env_name }}"
    state: absent
  register: delete_result

- name: Verify deletion
  assert:
    that:
      - delete_result.changed
      - delete_result.environment.state == 'deleted'
    fail_msg: "Environment deletion failed"
    success_msg: "âœ“ Environment deleted successfully"

# Test 10: Verify deletion idempotency
- name: Try to delete already-deleted environment
  basicPr0grammer.azure_devops.azure_devops_environment:
    organization_url: "{{ organization_url }}"
    project: "{{ YourProject }}project_name }}"
    name: "{{ test_env_name }}"
    state: absent
  register: delete_again

- name: Verify deletion idempotency
  assert:
    that:
      - not delete_again.changed
    fail_msg: "Deletion idempotency check failed"
    success_msg: "âœ“ Deletion idempotency verified"

# Clean up: Delete the complete environment
- name: Clean up - delete complete environment
  basicPr0grammer.azure_devops.azure_devops_environment:
    organization_url: "{{ organization_url }}"
    project: "{{ YourProject }}project_name }}"
    name: "{{ test_env_name }}-complete"
    state: absent
  register: cleanup_result

- name: Verify cleanup
  assert:
    that:
      - cleanup_result.changed
    fail_msg: "Cleanup failed"
    success_msg: "âœ“ Cleanup completed"

- name: Display test summary
  debug:
    msg: |
      
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘  ENVIRONMENT MODULE INTEGRATION TESTS COMPLETED            â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      âœ“ Create environment
      âœ“ Create idempotency
      âœ“ Update environment
      âœ“ Configure approvers
      âœ“ Approvers idempotency
      âœ“ Grant pipeline permissions
      âœ“ Pipeline permissions idempotency
      âœ“ Create complete environment
      âœ“ Delete environment
      âœ“ Delete idempotency
      
      All tests passed! ğŸ‰
